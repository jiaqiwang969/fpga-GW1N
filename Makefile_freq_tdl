#==============================================================================
# GW1N-LV9 互易计数 + TDL 实验顶层 Makefile
#------------------------------------------------------------------------------
# 顶层模块 : freq_recip_uart_ch0_tdl_top
# 说明     :
#   - 与原 freq_recip_uart_ch0_top 相同，只是 fast 核心实例将 USE_TDL=1'b1；
#   - 用于在 fast 域启用 TDL 细时间测量并通过 UART 输出 R=NNNNNN,CCCCCC,FF；
#   - 主工程仍使用原 Makefile / 顶层，不受本实验影响。
#==============================================================================

DEVICE      := GW1N-LV9QN48C6/I5
FAMILY      := GW1N-9

RTL_DIR     := rtl
PROJ_DIR    := project
BUILD_DIR   := build_fpga_tdl

TOP         := freq_recip_uart_ch0_tdl_top

VERILOG_SRCS := \
	$(RTL_DIR)/edge_detect.v \
	$(RTL_DIR)/uart_tx.v \
	$(RTL_DIR)/simple_tdc_core.v \
	$(RTL_DIR)/tdl_fine_stop.v \
	$(RTL_DIR)/gowin_rpll_400m.v \
	$(RTL_DIR)/recip_core_fast.v \
	$(RTL_DIR)/freq_recip_uart_ch0_tdl_top.v

CST_FILE    := $(PROJ_DIR)/freq_recip_uart_ch0.cst

JSON_FILE   := $(BUILD_DIR)/$(TOP).json
PNR_FILE    := $(BUILD_DIR)/$(TOP)_pnr.json
BIT_FILE    := $(BUILD_DIR)/$(TOP).fs

.PHONY: all
all: $(BIT_FILE)

$(BUILD_DIR):
	mkdir -p $(BUILD_DIR)

$(JSON_FILE): $(VERILOG_SRCS) | $(BUILD_DIR)
	@echo "=========================================="
	@echo "综合 互易计数 + TDL 实验顶层 (Yosys + synth_gowin)..."
	@echo "  顶层: $(TOP)"
	@echo "=========================================="
	yosys -p "read_verilog $(VERILOG_SRCS); synth_gowin -top $(TOP) -json $(JSON_FILE)"

$(PNR_FILE): $(JSON_FILE) $(CST_FILE)
	@echo "=========================================="
	@echo "布局布线 互易计数 + TDL 实验顶层 (nextpnr-himbaechel)..."
	@echo "  器件 : $(DEVICE)"
	@echo "  家族 : $(FAMILY)"
	@echo "  约束 : $(CST_FILE)"
	@echo "=========================================="
	nextpnr-himbaechel \
		--json $(JSON_FILE) \
		--write $(PNR_FILE) \
		--device $(DEVICE) \
		--vopt family=$(FAMILY) \
		--vopt cst=$(CST_FILE)

$(BIT_FILE): $(PNR_FILE)
	@echo "=========================================="
	@echo "生成 互易计数 + TDL 实验比特流 (gowin_pack)..."
	@echo "  输入 : $(PNR_FILE)"
	@echo "  输出 : $(BIT_FILE)"
	@echo "=========================================="
	gowin_pack -d $(FAMILY) -o $(BIT_FILE) $(PNR_FILE)

.PHONY: prog
prog: $(BIT_FILE)
	@echo "=========================================="
	@echo "下载 互易计数 + TDL 实验顶层到 FPGA (openFPGALoader, SRAM)..."
	@echo "  使用 FT232 JTAG 接口 (--c ft232)"
	@echo "=========================================="
	openFPGALoader -c ft232 $(BIT_FILE)

.PHONY: clean
clean:
	@echo "清理 互易计数 + TDL 实验构建目录: $(BUILD_DIR)"
	rm -rf $(BUILD_DIR)

